<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>state-interface</title>
</head>

<body>
    <main>
        <canvas id="canvas" width="600" height="360"></canvas>
        <p id="display">unedited</p>
        <div id="app"></div>
    </main>
    <script src="./build/main.js"></script>
    <script>
        const elmApp = Elm.Main.init({ node: document.getElementById("app") });
        let htmlEventListenerAbortControllers = {}
        const imageData = new ImageData(600, 360);

        const interfaceImplementations = [
            {
                detect: event => event?.display,
                onAdd: (config, sendToElm) => {
                    document.getElementById("display").textContent = config
                    sendToElm(null)
                },
            },
            {
                detect: event => event?.requestTimeNow,
                onAdd: (config, sendToElm) => {
                    sendToElm(Date.now())
                },
            },
            {
                detect: event => event?.draw,
                onAdd: (config, sendToElm) => {
                    (async function () {
                        const canvas = document.getElementById("canvas")
                        const canvasContext = canvas.getContext("2d")
                        for (let y = 0; y < canvas.clientHeight; y++) {
                            for (let x = 0; x < canvas.clientWidth; x++) {
                                const pixelIndex = (y * canvas.clientWidth + x) * 4
                                const color = config[y][x]
                                imageData.data[pixelIndex] = color.red
                                imageData.data[pixelIndex + 1] = color.green
                                imageData.data[pixelIndex + 2] = color.blue
                                imageData.data[pixelIndex + 3] = color.alpha
                            }
                        }
                        canvasContext.putImageData(imageData, 0, 0)
                        return null
                    })().then(sendToElm)
                },
            },
            {
                detect: event => event?.listenToHtmlEvent,
                onAdd: function (config, sendToElm) {
                    const canvas = document.getElementById("canvas")
                    const abortController = new AbortController()
                    htmlEventListenerAbortControllers[config] = abortController;
                    canvas.addEventListener(
                        config,
                        (triggeredEvent) => {
                            sendToElm(triggeredEvent)
                        },
                        { signal: abortController.signal }
                    )
                },
                onRemove: config => {
                    let maybeAbortController = htmlEventListenerAbortControllers[event.listenToHtmlEvent]
                    if (maybeAbortController) {
                        maybeAbortController.abort()
                        delete htmlEventListenerAbortControllers[event.listenToHtmlEvent]
                    }
                }
            }
        ]

        elmApp.ports.toJs.subscribe(function (fromElm) {
            // console.log("elm → js: ", fromElm)
            function sendToElm(eventData) {
                const toElm = { interface: fromElm.interface, eventData: eventData }
                elmApp.ports.fromJs.send(toElm)
                // console.log("js → elm: ", toElm)
            }

            interfaceImplementations.forEach(interfaceImplementation => {
                if (interfaceImplementation.detect(fromElm.interface)) {
                    const specific = interfaceImplementation.detect(fromElm.interface)
                    if (fromElm.changeAction == "add") {
                        interfaceImplementation.onAdd(specific, sendToElm)
                    } else {
                        if (interfaceImplementation?.remove) {
                            interfaceImplementation.onRemove(specific)
                        }
                    }
                }
            })
        });
    </script>
</body>

</html>