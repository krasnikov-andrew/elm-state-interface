<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>elm nicer architecture</title>
</head>

<body>
    <main>
        <p id="display">unedited</p>
        <canvas id="canvas" width="600" height="360"></canvas>
        <div id="app"></div>
    </main>
    <script src="./build/main.js"></script>
    <script>
        const app = Elm.Main.init({ node: document.getElementById("app") });

        app.ports.portOut.subscribe(function (fromElm) {
            console.log("elm â†’ js: " + fromElm)
            if (fromElm?.addedInterface) {
                function trySpecificInterface(toSpecific, run) {
                    const maybeSpecific = toSpecific(fromElm.addedInterface);
                    if (maybeSpecific) {
                        run(maybeSpecific)
                            .then(eventData => {
                                app.ports.portIn.send({ interface: fromElm.addedInterface, eventData: eventData })
                            });
                    }
                }
                trySpecificInterface(
                    event => event?.display,
                    async function (config) {
                        document.getElementById("display").textContent = config;
                        return null;
                    }
                );
                trySpecificInterface(
                    event => event?.requestTimeNow,
                    async function (config) {
                        return Date.now();
                    }
                );
                trySpecificInterface(
                    event => event?.draw,
                    async function (config) {
                        const canvas = document.getElementById("canvas");
                        const canvasContext = canvas.getContext("2d");
                        const pixelData = [];
                        for (let y = 0; y < canvas.clientHeight; y++) {
                            for (let x = 0; x < canvas.clientWidth; x++) {
                                const color = config[y][x];
                                pixelData.push(color.red);
                                pixelData.push(color.green);
                                pixelData.push(color.blue);
                                pixelData.push(color.alpha);
                            }
                        }
                        const imageData = new ImageData(new Uint8ClampedArray(pixelData), 600, 360);
                        canvasContext.putImageData(imageData, 0, 0);
                        return null;
                    }
                )
            } else if (fromElm?.removedInterface) {
                // you can stop that process here. Currently not needed
            }
        });
    </script>
</body>

</html>