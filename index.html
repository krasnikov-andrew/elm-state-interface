<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>elm nicer architecture</title>
</head>

<body>
    <main>
        <canvas id="canvas" width="600" height="360"></canvas>
        <p id="display">unedited</p>
        <div id="app"></div>
    </main>
    <script src="./build/main.js"></script>
    <script>
        const elmApp = Elm.Main.init({ node: document.getElementById("app") });
        let htmlEventListenerAbortControllers = {}

        elmApp.ports.portOut.subscribe(function (fromElm) {
            console.log("elm → js: ", fromElm)
            if (fromElm?.addedInterface) {
                function sendToElm(eventData) {
                    const toElm = { interface: fromElm.addedInterface, eventData: eventData }
                    elmApp.ports.portIn.send(toElm)
                    console.log("js → elm: ", toElm)
                }

                function trySpecificInterface(toSpecific, run) {
                    if (toSpecific(fromElm.addedInterface)) {
                        run(toSpecific(fromElm.addedInterface))
                            .then(eventData => {
                                sendToElm(eventData)
                            });
                    }
                }
                trySpecificInterface(
                    event => event?.display,
                    async function (config) {
                        document.getElementById("display").textContent = config;
                        return null;
                    }
                );
                trySpecificInterface(
                    event => event?.requestTimeNow,
                    async function (config) {
                        return Date.now();
                    }
                );
                trySpecificInterface(
                    event => event?.draw,
                    async function (config) {
                        const canvas = document.getElementById("canvas");
                        const canvasContext = canvas.getContext("2d");
                        const pixelData = [];
                        for (let y = 0; y < canvas.clientHeight; y++) {
                            for (let x = 0; x < canvas.clientWidth; x++) {
                                const color = config[y][x];
                                pixelData.push(color.red);
                                pixelData.push(color.green);
                                pixelData.push(color.blue);
                                pixelData.push(color.alpha);
                            }
                        }
                        const imageData = new ImageData(new Uint8ClampedArray(pixelData), 600, 360);
                        canvasContext.putImageData(imageData, 0, 0);
                        return null;
                    }
                )
                if (fromElm.addedInterface?.listenToHtmlEvent) {
                    const canvas = document.getElementById("canvas")
                    const abortController = new AbortController()
                    htmlEventListenerAbortControllers[fromElm.addedInterface.listenToHtmlEvent] = abortController;
                    canvas.addEventListener(
                        fromElm.addedInterface.listenToHtmlEvent,
                        (triggeredEvent) => {
                            sendToElm(triggeredEvent)
                        },
                        { signal: abortController.signal }
                    )
                }
            } else if (fromElm?.removedInterface) {
                if (event?.listenToHtmlEvent) {
                    let maybeAbortController = htmlEventListenerAbortControllers[event.listenToHtmlEvent]
                    if (maybeAbortController) {
                        maybeAbortController.abort()
                        delete htmlEventListenerAbortControllers[event.listenToHtmlEvent]
                    }
                }
            }
        });
    </script>
</body>

</html>